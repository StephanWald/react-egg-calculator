---
phase: 04-services-hooks
plan: 03
type: execute
wave: 3
depends_on: ["04-01", "04-02"]
files_modified:
  - egg-calculator.jsx
autonomous: true

must_haves:
  truths:
    - "Component imports and uses all 4 hooks (useSettings, useUnitConversion, useTimerLogic, useLocationPressure)"
    - "Component no longer contains inline localStorage logic, timer countdown effects, or API fetch calls"
    - "Application renders identically to before extraction (visual parity)"
    - "All existing tests pass without modification"
    - "All new hook and service tests pass"
  artifacts:
    - path: "egg-calculator.jsx"
      provides: "Refactored component using extracted hooks"
      min_lines: 700
      contains: "useSettings"
  key_links:
    - from: "egg-calculator.jsx"
      to: "hooks/useSettings.js"
      via: "import and destructure"
      pattern: "import.*useSettings.*hooks/useSettings"
    - from: "egg-calculator.jsx"
      to: "hooks/useUnitConversion.js"
      via: "import and destructure"
      pattern: "import.*useUnitConversion.*hooks/useUnitConversion"
    - from: "egg-calculator.jsx"
      to: "hooks/useTimerLogic.js"
      via: "import and destructure"
      pattern: "import.*useTimerLogic.*hooks/useTimerLogic"
    - from: "egg-calculator.jsx"
      to: "hooks/useLocationPressure.js"
      via: "import and destructure"
      pattern: "import.*useLocationPressure.*hooks/useLocationPressure"
---

<objective>
Rewire egg-calculator.jsx to import and use all extracted hooks and services, removing ~300 lines of inline logic while preserving identical application behavior.

Purpose: Complete the Phase 4 extraction by connecting the new modules to the component. This is the critical integration step where extracted hooks replace inline state management.
Output: A significantly smaller egg-calculator.jsx (~700-900 lines vs current 1210) that delegates to hooks for settings, units, timer, and location/pressure.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-services-hooks/04-CONTEXT.md
@.planning/phases/04-services-hooks/04-01-SUMMARY.md
@.planning/phases/04-services-hooks/04-02-SUMMARY.md

@egg-calculator.jsx (the full component to rewire)
@hooks/useSettings.js
@hooks/useUnitConversion.js
@hooks/useTimerLogic.js
@hooks/useLocationPressure.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire component to use extracted hooks</name>
  <files>egg-calculator.jsx</files>
  <action>
    Replace inline state management in egg-calculator.jsx with imports from the new hooks. Work section by section to avoid breaking behavior.

    **New imports** (add after existing imports):
    ```
    import { useSettings } from './hooks/useSettings';
    import { useUnitConversion } from './hooks/useUnitConversion';
    import { useTimerLogic } from './hooks/useTimerLogic';
    import { useLocationPressure } from './hooks/useLocationPressure';
    ```

    **Replace SETTINGS (lines 68-136, 229-270):**
    - Replace ALL the individual useState calls for household settings, working inputs, and the two useEffect blocks for localStorage load/save with:
      ```
      const { settings, updateSetting, resetSettings } = useSettings();
      ```
    - Destructure from settings what the component needs:
      ```
      const {
        weight, startTemp, targetTemp, consistency, eggCount, waterVolume,
        stoveType, stovePower, stoveEfficiency, potWeight, potMaterial,
        waterStartTemp, ambientTemp,
        altitude: settingsAltitude, pressure: settingsPressure,
        boilingPoint: settingsBoilingPoint, locationName: settingsLocationName,
        pressureSource: settingsPressureSource,
        notificationPermission: savedNotificationPermission,
      } = settings;
      ```
    - Replace all `setWeight(x)` calls with `updateSetting('weight', x)`, etc.
    - Replace `handleResetToDefaults()` with `resetSettings()`
    - IMPORTANT: Settings persistence for location/pressure needs coordination with useLocationPressure. When useLocationPressure updates pressure/altitude/etc, the component must also call updateSetting to persist those values. Wire this in the event handlers.

    **Replace UNIT PREFERENCES (lines 62-66):**
    - Replace the 4 unit useState calls with:
      ```
      const { tempUnit, setTempUnit, volumeUnit, setVolumeUnit, weightUnit, setWeightUnit, pressureUnit, setPressureUnit } = useUnitConversion({
        tempUnit: settings.tempUnit,
        volumeUnit: settings.volumeUnit,
        weightUnit: settings.weightUnit,
        pressureUnit: settings.pressureUnit,
      });
      ```
    - When unit changes, also persist: wrap setTempUnit etc. to also call `updateSetting('tempUnit', newValue)`, or use useEffect to sync.

    **Replace TIMER (lines 55-60, 138-143, 146-171, 173-227, 408-496):**
    - Replace all timer useState calls with:
      ```
      const {
        timerActive, timerPaused, timerRemaining, timerComplete, notificationPermission,
        startTimer, stopTimer, pauseTimer, resumeTimer, dismissComplete
      } = useTimerLogic();
      ```
    - Remove: countdown useEffect, completion notification useEffect, notification permission check useEffect, playTimerSound function, handleStartTimer/handleStopTimer functions, startTimer/stopTimer/pauseTimer/resumeTimer inline functions
    - Keep the Escape key handler in the component (it coordinates timer + configDialog -- research Open Question 3). Update it to use hook functions: `stopTimer()` instead of manually setting state.
    - Update handleStartTimer to: calculate timeInSeconds from cookingTime, call `startTimer(timeInSeconds)`
    - Update timer overlay UI to use `dismissComplete()` instead of inline state resets

    **Replace LOCATION/PRESSURE (lines 32-39, 289-374):**
    - Replace location/pressure useState calls with:
      ```
      const {
        altitude, pressure, boilingPoint, locationName, locationLoading, locationError,
        pressureSource, getLocationAndPressure, handleManualPressure, handleManualBoilingPoint,
        setAltitude, setPressure, setBoilingPoint, setLocationName, setPressureSource
      } = useLocationPressure();
      ```
    - Remove: inline getLocationAndPressure, handleManualPressure, handleManualBoilingPoint functions
    - Initialize location state from persisted settings on mount: use a useEffect that reads settings and calls the location hook setters for persisted values (altitude, pressure, boilingPoint, locationName, pressureSource). Only do this once on mount.
    - When location hook updates values (after GPS fetch), persist them via updateSetting calls. Wrap getLocationAndPressure: call the hook method, then in a .then() or after await, persist the new values.
    - For locationError: the hook returns error CODES ('PERMISSION_DENIED', 'POSITION_UNAVAILABLE', 'LOCATION_ERROR'). Map these to translated messages in the component using `t()`.

    **CRITICAL RULES:**
    1. Copy exact logic first, verify, then remove old code. Do not refactor behavior.
    2. The main calculation useEffect (lines 378-406) stays in the component -- it depends on many settings values and calls calculateTimePhysics.
    3. UI state (showSettings, showAdvanced, showEnergy, showConfigDialog) stays in the component.
    4. The Escape key handler stays in the component but uses hook functions.
    5. getEggVisualization, handleConsistencyChange, handleStoveTypeChange stay in the component.
    6. Run `npx vitest run` after each major section replacement to catch regressions early.

    **Expected result:** egg-calculator.jsx drops from ~1210 lines to ~700-900 lines. All removed code is now in hook/service modules.
  </action>
  <verify>
    Run `npx vitest run` -- all tests pass (existing + new).
    Run `npm run build` -- production build succeeds with no errors.
  </verify>
  <done>
    egg-calculator.jsx imports all 4 hooks, no longer contains inline localStorage logic, timer effects, API fetches, or audio helpers. Component is ~700-900 lines. All tests pass. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify visual and functional parity</name>
  <files>egg-calculator.jsx</files>
  <action>
    Run the dev server and verify the application works identically to before extraction.

    1. Run `npm run dev` to start the development server
    2. Run `npm run build` to verify production build succeeds
    3. Run `npx vitest run` to verify ALL tests pass (existing smoke test + physics + constants + converters + formatters + all new service/hook tests)
    4. Verify no console errors or warnings in the build output
    5. Check that egg-calculator.jsx:
       - Has NO inline localStorage getItem/setItem (should be in useSettings)
       - Has NO setInterval for timer countdown (should be in useTimerLogic)
       - Has NO fetch() calls to open-meteo or nominatim (should be in useLocationPressure via services)
       - Has NO AudioContext/playTimerSound (should be in useTimerLogic)
       - Has NO useState for timer state variables (should be from useTimerLogic)
       - Has NO useState for unit preference variables (should be from useUnitConversion)
       - Still HAS: UI state (showSettings, etc.), working input handlers, main calculation useEffect, render JSX

    If any test fails, fix the integration issue in egg-calculator.jsx. The hooks and services should NOT be modified in this task -- any issues should be resolved by adjusting how the component calls the hooks.
  </action>
  <verify>
    `npx vitest run` exits with 0 (all tests pass).
    `npm run build` exits with 0 (production build succeeds).
    egg-calculator.jsx contains no localStorage, no setInterval, no fetch to APIs, no AudioContext.
  </verify>
  <done>
    Full test suite passes. Production build succeeds. Component delegates all settings persistence, timer logic, location/pressure fetching, and unit conversion to extracted hooks. No inline duplicated logic remains. Phase 4 extraction complete.
  </done>
</task>

</tasks>

<verification>
Complete phase verification:
1. `npx vitest run` -- ALL tests pass (count should be significantly higher than before Phase 4)
2. `npm run build` -- production build succeeds
3. Component line count: `wc -l egg-calculator.jsx` shows ~700-900 lines (down from 1210)
4. No inline logic: grep confirms no localStorage, setInterval, fetch-to-API, or AudioContext in component
5. Hook imports: egg-calculator.jsx imports useSettings, useUnitConversion, useTimerLogic, useLocationPressure
</verification>

<success_criteria>
- egg-calculator.jsx reduced to ~700-900 lines
- All 4 hooks imported and used in the component
- No localStorage, timer, API fetch, or audio logic remains inline
- All existing + new tests pass
- Production build succeeds
- Application behavior unchanged (pure structural refactoring)
</success_criteria>

<output>
After completion, create `.planning/phases/04-services-hooks/04-03-SUMMARY.md`
</output>

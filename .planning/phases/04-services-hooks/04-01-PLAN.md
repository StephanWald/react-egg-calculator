---
phase: 04-services-hooks
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - services/meteoApi.js
  - services/geocodingApi.js
  - hooks/useSettings.js
  - hooks/useUnitConversion.js
  - test/services/meteoApi.test.js
  - test/services/geocodingApi.test.js
  - test/hooks/useSettings.test.js
  - test/hooks/useUnitConversion.test.js
autonomous: true

must_haves:
  truths:
    - "fetchSurfacePressure returns pressure and elevation from Open-Meteo API"
    - "fetchLocationName returns city name from Nominatim reverse geocoding"
    - "useSettings loads saved settings from localStorage on mount, merging with defaults"
    - "useSettings auto-persists on every state change"
    - "resetSettings clears localStorage and returns to defaults"
    - "useUnitConversion manages temp, volume, weight, pressure unit preferences"
  artifacts:
    - path: "services/meteoApi.js"
      provides: "Open-Meteo pressure API wrapper"
      exports: ["fetchSurfacePressure"]
    - path: "services/geocodingApi.js"
      provides: "Nominatim reverse geocoding wrapper"
      exports: ["fetchLocationName"]
    - path: "hooks/useSettings.js"
      provides: "Settings persistence hook with localStorage"
      exports: ["useSettings"]
    - path: "hooks/useUnitConversion.js"
      provides: "Unit preference state hook"
      exports: ["useUnitConversion"]
    - path: "test/services/meteoApi.test.js"
      provides: "API service tests"
    - path: "test/services/geocodingApi.test.js"
      provides: "Geocoding service tests"
    - path: "test/hooks/useSettings.test.js"
      provides: "Settings hook tests"
    - path: "test/hooks/useUnitConversion.test.js"
      provides: "Unit conversion hook tests"
  key_links:
    - from: "services/meteoApi.js"
      to: "global.fetch"
      via: "fetch call to Open-Meteo endpoint"
      pattern: "fetch.*api\\.open-meteo\\.com"
    - from: "services/geocodingApi.js"
      to: "global.fetch"
      via: "fetch call to Nominatim endpoint"
      pattern: "fetch.*nominatim\\.openstreetmap\\.org"
    - from: "hooks/useSettings.js"
      to: "localStorage"
      via: "getItem/setItem for persistence"
      pattern: "localStorage\\.(getItem|setItem|removeItem)"
---

<objective>
Create API service modules (meteoApi.js, geocodingApi.js) and foundation hooks (useSettings, useUnitConversion) with comprehensive tests.

Purpose: Extract the independent, non-React service layer and simpler hooks first, establishing the module structure that complex hooks (Plan 02) will build on.
Output: 4 source modules in services/ and hooks/ directories, plus 4 test files with full coverage.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-services-hooks/04-CONTEXT.md
@.planning/phases/04-services-hooks/04-RESEARCH.md

Source code to extract from:
@egg-calculator.jsx (lines 68-136 for settings persistence, lines 62-66 for unit preferences, lines 305-342 for API calls)
@useTranslation.js (hook pattern precedent: lazy initializer, useEffect persistence, useCallback)
@constants.js (for DEFAULTS reference in useSettings)
@vite.config.js (test config: jsdom, globals, setupFiles)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API service modules with tests</name>
  <files>
    services/meteoApi.js
    services/geocodingApi.js
    test/services/meteoApi.test.js
    test/services/geocodingApi.test.js
  </files>
  <action>
    Create `services/` directory and two thin API wrapper modules. These are plain async functions with NO React imports.

    **services/meteoApi.js:**
    - Export `fetchSurfacePressure(latitude, longitude)` as async function
    - Fetch from `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=surface_pressure`
    - If response not ok, throw `Error('Weather data unavailable (${response.status})')`
    - Return `{ surfacePressure: data.current.surface_pressure, elevation: data.elevation ?? null }`
    - Match the exact logic from egg-calculator.jsx lines 305-312

    **services/geocodingApi.js:**
    - Export `fetchLocationName(latitude, longitude)` as async function
    - Fetch from `https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&zoom=10`
    - If response not ok, return `null` (geocoding is informational-only, should not throw)
    - Extract city from `data.address?.city || data.address?.town || data.address?.village`
    - Return the city string or `null`
    - Match the exact logic from egg-calculator.jsx lines 331-341

    **test/services/meteoApi.test.js** (create `test/services/` directory):
    - Use `vi.spyOn(global, 'fetch')` in beforeEach, `vi.restoreAllMocks()` in afterEach
    - Test cases:
      1. Returns surfacePressure and elevation for valid coordinates
      2. Passes correct URL with latitude/longitude parameters
      3. Throws on non-ok response (status 500)
      4. Throws on network error
      5. Returns null elevation when API response has no elevation field

    **test/services/geocodingApi.test.js:**
    - Same fetch spy pattern
    - Test cases:
      1. Returns city name from address.city
      2. Falls back to address.town when city is missing
      3. Falls back to address.village when town is missing
      4. Returns null when response is not ok (does not throw)
      5. Returns null when no city/town/village in response
      6. Returns null on network error (does not throw)

    Follow research patterns exactly. See 04-RESEARCH.md "Testing API Service with Fetch Mock" section for the mock pattern.
  </action>
  <verify>
    Run `npx vitest run test/services/` and confirm all tests pass.
  </verify>
  <done>
    meteoApi.js exports fetchSurfacePressure, geocodingApi.js exports fetchLocationName, all service tests pass, services have zero React imports.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useSettings and useUnitConversion hooks with tests</name>
  <files>
    hooks/useSettings.js
    hooks/useUnitConversion.js
    test/hooks/useSettings.test.js
    test/hooks/useUnitConversion.test.js
  </files>
  <action>
    Create `hooks/` directory and two React hooks. Follow useTranslation.js pattern (lazy initializer, useEffect persistence, useCallback).

    **hooks/useSettings.js:**
    - Export `useSettings()` hook
    - Use STORAGE_KEY `'egg-calculator-settings'`
    - Define DEFAULTS object matching the current component defaults:
      ```
      weight: 60, startTemp: 4, targetTemp: 67, consistency: 'medium',
      eggCount: 1, waterVolume: 1.5,
      stoveType: 'induction', stovePower: 2000, stoveEfficiency: 0.87,
      potWeight: 0.8, potMaterial: 'steel',
      waterStartTemp: 15, ambientTemp: 22,
      altitude: 0, pressure: 1013.25, boilingPoint: 100,
      locationName: null, pressureSource: 'default',
      tempUnit: 'C', volumeUnit: 'L', weightUnit: 'g', pressureUnit: 'hPa',
      notificationPermission: 'default'
      ```
    - Lazy initializer: load from localStorage, merge with DEFAULTS (missing keys get defaults)
    - Handle corrupt JSON gracefully (return DEFAULTS)
    - useEffect: auto-persist on every `settings` change
    - Export: `{ settings, updateSetting(key, value), resetSettings() }`
    - `updateSetting` uses `useCallback` and functional setState: `prev => ({ ...prev, [key]: value })`
    - `resetSettings` clears localStorage AND resets state to DEFAULTS
    - Also export DEFAULTS (named export) so tests can reference them

    **hooks/useUnitConversion.js:**
    - Export `useUnitConversion(initial = {})` hook
    - Parameter-based (following Phase 3 formatter pattern): accepts optional initial values, does NOT read from useSettings
    - useState for: tempUnit (default 'C'), volumeUnit (default 'L'), weightUnit (default 'g'), pressureUnit (default 'hPa')
    - Return: `{ tempUnit, setTempUnit, volumeUnit, setVolumeUnit, weightUnit, setWeightUnit, pressureUnit, setPressureUnit, units }` where `units` is `{ tempUnit, volumeUnit, weightUnit, pressureUnit }` convenience object

    **test/hooks/useSettings.test.js:**
    - Use `renderHook` from `@testing-library/react`, `act` for state updates
    - `localStorage.clear()` in beforeEach and afterEach
    - Test cases (following research examples exactly):
      1. Returns defaults when no saved settings
      2. Loads saved settings from localStorage
      3. Merges saved settings with defaults (missing keys get defaults)
      4. Auto-persists on update
      5. resetSettings clears localStorage and returns to defaults
      6. Handles corrupt localStorage gracefully (falls back to defaults)
      7. updateSetting updates a single key without affecting others

    **test/hooks/useUnitConversion.test.js:**
    - Test cases:
      1. Returns default units (C, L, g, hPa)
      2. Accepts initial unit overrides
      3. Updates temperature unit via setTempUnit
      4. Updates volume unit via setVolumeUnit
      5. Updates weight unit via setWeightUnit
      6. Updates pressure unit via setPressureUnit
      7. Returns units convenience object reflecting current state

    IMPORTANT: Use `vi.advanceTimersByTimeAsync` if any timers are involved (none expected here but be safe). Do NOT import from `@testing-library/react-hooks` (deprecated). Import `renderHook` and `act` from `@testing-library/react`.
  </action>
  <verify>
    Run `npx vitest run test/hooks/useSettings.test.js test/hooks/useUnitConversion.test.js` and confirm all tests pass.
  </verify>
  <done>
    useSettings exports hook with settings/updateSetting/resetSettings, useUnitConversion exports hook with unit state and setters, all hook tests pass, hooks follow useTranslation.js pattern.
  </done>
</task>

</tasks>

<verification>
Run full test suite: `npx vitest run`
- All existing tests (physics, constants, converters, formatters, smoke) still pass
- All new service tests pass (test/services/*.test.js)
- All new hook tests pass (test/hooks/*.test.js)
- No new dependencies installed (verify package.json unchanged)
</verification>

<success_criteria>
- services/meteoApi.js and services/geocodingApi.js exist as thin async wrappers with no React imports
- hooks/useSettings.js persists to localStorage, merges with defaults, supports reset
- hooks/useUnitConversion.js manages 4 unit preferences with parameter-based initialization
- All 4 test files pass with comprehensive coverage
- Existing test suite unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/04-services-hooks/04-01-SUMMARY.md`
</output>

---
phase: 01-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vite.config.js
  - test/setup.js
  - egg-calculator.test.jsx
autonomous: true

must_haves:
  truths:
    - "`npm test` runs Vitest with jsdom environment and exits successfully"
    - "`npm run test:coverage` generates v8 coverage report output"
    - "`npm run test:watch` starts Vitest in watch mode"
    - "React Testing Library jest-dom matchers (e.g. toBeInTheDocument) are available in test files without per-file imports"
    - "Smoke test proves EggCalculator renders without crashing"
  artifacts:
    - path: "package.json"
      provides: "Test scripts and dev dependencies"
      contains: "vitest"
    - path: "vite.config.js"
      provides: "Vitest test configuration with jsdom environment"
      contains: "environment: 'jsdom'"
    - path: "test/setup.js"
      provides: "Global test setup importing jest-dom matchers"
      contains: "@testing-library/jest-dom/vitest"
    - path: "egg-calculator.test.jsx"
      provides: "Smoke test proving infrastructure works"
      contains: "renders without crashing"
  key_links:
    - from: "vite.config.js"
      to: "test/setup.js"
      via: "setupFiles config"
      pattern: "setupFiles.*test/setup"
    - from: "test/setup.js"
      to: "@testing-library/jest-dom/vitest"
      via: "import statement"
      pattern: "import.*@testing-library/jest-dom/vitest"
    - from: "egg-calculator.test.jsx"
      to: "egg-calculator.jsx"
      via: "import and render"
      pattern: "import.*EggCalculator.*from.*egg-calculator"
    - from: "package.json"
      to: "vitest"
      via: "test scripts"
      pattern: "\"test\".*vitest"
---

<objective>
Configure Vitest test infrastructure with React Testing Library, jsdom environment, v8 coverage, and a smoke test that proves the setup works end-to-end.

Purpose: Establish the testing foundation that all subsequent phases (2-7) depend on. Without working test infrastructure, no physics validation, refactoring safety net, or quality gates are possible.

Output: Four modified/created files (package.json, vite.config.js, test/setup.js, egg-calculator.test.jsx) and three working npm scripts (test, test:watch, test:coverage).
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-test-infrastructure/01-RESEARCH.md

Source files:
@vite.config.js
@package.json
@egg-calculator.jsx (smoke test target - default export, renders top-level div)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and configure test infrastructure</name>
  <files>package.json, vite.config.js, test/setup.js</files>
  <action>
    1. Install dev dependencies (single command):
       ```
       npm install -D vitest@^4.0.18 @testing-library/react@^16.3.2 @testing-library/jest-dom@^6.9.1 @testing-library/user-event@^14.6.1 jsdom@^26.1.0 @vitest/coverage-v8@^4.0.18
       ```
       CRITICAL: jsdom must be ^26.x NOT ^27.x (known Vitest 4 compatibility issues, ERR_REQUIRE_ESM errors).

    2. Add test scripts to package.json (in the "scripts" section, alongside existing dev/build/preview):
       ```json
       "test": "vitest run",
       "test:watch": "vitest",
       "test:coverage": "vitest run --coverage"
       ```
       NOTE: "test" uses `vitest run` (single run, exits with code) for CI/quick checks. "test:watch" uses bare `vitest` (watch mode by default) for TDD workflow. "test:coverage" uses `vitest run --coverage` for coverage reports.

    3. Add test section to vite.config.js (inside the defineConfig object, after the build section):
       ```javascript
       test: {
         globals: true,
         environment: 'jsdom',
         setupFiles: ['./test/setup.js'],
         coverage: {
           provider: 'v8',
           reporter: ['text', 'json', 'html'],
         },
       },
       ```
       NOTE: globals: true enables automatic cleanup() after each test. Source files are at root level (no src/ directory), so setupFiles path is `./test/setup.js`. Do NOT create a separate vitest.config.js -- add to existing vite.config.js.

    4. Create test/setup.js with a single line:
       ```javascript
       import '@testing-library/jest-dom/vitest';
       ```
       This makes jest-dom matchers (toBeInTheDocument, toBeDisabled, toHaveTextContent, etc.) available globally in all test files without per-file imports.
  </action>
  <verify>
    Run `npm test` -- should output "no test files found" or similar (no tests exist yet), but should NOT error on configuration. Vitest should initialize with jsdom environment.
    Run `node -e "const pkg = require('./package.json'); console.log(pkg.scripts.test, pkg.scripts['test:watch'], pkg.scripts['test:coverage'])"` to confirm all three scripts exist.
    Verify test/setup.js exists with correct content.
  </verify>
  <done>
    - All 6 dev dependencies installed and in package.json devDependencies
    - Three test scripts present in package.json (test, test:watch, test:coverage)
    - vite.config.js has test section with globals: true, environment: 'jsdom', setupFiles, and coverage config
    - test/setup.js exists with jest-dom/vitest import
    - `npm test` does not error on configuration (may report no tests found)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create smoke test and verify full infrastructure</name>
  <files>egg-calculator.test.jsx</files>
  <action>
    1. Create egg-calculator.test.jsx at project root (colocated with egg-calculator.jsx):
       ```jsx
       import { render, screen } from '@testing-library/react';
       import { describe, it, expect } from 'vitest';
       import EggCalculator from './egg-calculator';

       describe('EggCalculator', () => {
         it('renders without crashing', () => {
           render(<EggCalculator />);
           // Component renders a top-level div with content.
           // Verify the component mounted by checking for visible text content.
           // The app title contains an egg emoji and translated title text.
           expect(document.querySelector('[class*="min-h-screen"]')).toBeInTheDocument();
         });
       });
       ```
       NOTE: The EggCalculator component does NOT use semantic HTML (no <main>, no role="main"). It renders a `<div className="min-h-screen ...">`. The smoke test verifies the component renders by checking this top-level container exists. Use `toBeInTheDocument()` (jest-dom matcher) to confirm setup file is working. Use explicit vitest imports (describe, it, expect) per research recommendations.

       IMPORTANT: If the component uses navigator.geolocation or fetch APIs that fail in jsdom, the test should still pass because location detection is user-triggered (not on mount). If act() warnings appear, they are non-blocking and expected with React 18 + RTL (known issue).

    2. Run all three npm scripts to verify full infrastructure:
       - `npm test` -- smoke test should pass, exit 0
       - `npm run test:coverage` -- should generate coverage report with v8 provider, show coverage percentages
       - `npm run test:watch` -- should start watch mode (cancel after confirming it starts)
  </action>
  <verify>
    `npm test` exits with code 0 and shows "1 passed" (or similar).
    `npm run test:coverage` exits with code 0 and shows coverage table output.
    `npm run test:watch` starts and shows "Waiting for file changes..." (or similar watch prompt). Cancel with Ctrl+C.
    All three test-related scripts from package.json work correctly.
  </verify>
  <done>
    - egg-calculator.test.jsx exists at project root
    - Smoke test passes: EggCalculator renders without crashing
    - `npm test` runs Vitest with jsdom, exits successfully
    - `npm run test:coverage` generates v8 coverage report
    - `npm run test:watch` starts watch mode
    - jest-dom matcher (toBeInTheDocument) works without per-file import (proving setup file works)
  </done>
</task>

</tasks>

<verification>
All five phase success criteria must be verified:

1. `npm test` runs Vitest with jsdom environment -- check output mentions "jsdom" or test passes (jsdom required for React rendering)
2. `npm run test:coverage` generates coverage reports via v8 -- check output contains coverage table with file names and percentages
3. `npm run test:watch` starts watch mode for TDD workflow -- check Vitest enters interactive watch mode
4. React Testing Library matchers available in all test files -- smoke test uses `toBeInTheDocument()` without importing jest-dom (proves setup file works)
5. Example smoke test proves setup works -- smoke test passes showing EggCalculator renders without crashing
</verification>

<success_criteria>
- All 6 devDependencies installed (vitest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event, jsdom, @vitest/coverage-v8)
- All 3 npm scripts work (test, test:watch, test:coverage)
- Smoke test passes: EggCalculator component renders
- jest-dom matchers work globally (toBeInTheDocument used without per-file import)
- Zero configuration errors from Vitest
</success_criteria>

<output>
After completion, create `.planning/phases/01-test-infrastructure/01-01-SUMMARY.md`
</output>

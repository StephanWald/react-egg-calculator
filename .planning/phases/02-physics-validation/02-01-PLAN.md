---
phase: 02-physics-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - physics.js
  - egg-calculator.jsx
autonomous: true

must_haves:
  truths:
    - "Physics functions are importable as named exports from physics.js"
    - "EggCalculator component still renders and calculates identically after extraction"
    - "All four physics formulas extracted: calculateBoilingPointFromPressure, calculatePressureFromBoilingPoint, calculateAltitudeFromPressure, calculateTime"
    - "Existing smoke test still passes"
  artifacts:
    - path: "physics.js"
      provides: "Exported physics calculation functions"
      exports: ["calculateBoilingPointFromPressure", "calculatePressureFromBoilingPoint", "calculateAltitudeFromPressure", "calculateTime"]
    - path: "egg-calculator.jsx"
      provides: "Component using imported physics functions"
      contains: "import.*from.*physics"
  key_links:
    - from: "egg-calculator.jsx"
      to: "physics.js"
      via: "ES module import"
      pattern: "import.*calculateBoilingPointFromPressure.*from.*physics"
---

<objective>
Extract all physics calculation functions from the EggCalculator component closure into a standalone `physics.js` module with named exports.

Purpose: Physics functions are currently trapped inside the component closure and cannot be directly unit tested. Extracting them as pure functions enables comprehensive physics validation in Plan 02. This is a safe refactoring because these functions are pure (no React state, no side effects) -- they take numbers in and return numbers out.

Output: A `physics.js` module exporting four physics functions, and an updated `egg-calculator.jsx` that imports from it. The app behavior must remain identical.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@egg-calculator.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract physics functions into physics.js</name>
  <files>physics.js</files>
  <action>
Create a new file `physics.js` in the project root (same level as `egg-calculator.jsx`).

Extract these four functions as named exports:

1. **calculateBoilingPointFromPressure(pressureHPa)**
   - Formula: `Math.round((100 + 0.037 * (pressureHPa - 1013.25)) * 10) / 10`
   - Currently at line 304 of egg-calculator.jsx

2. **calculatePressureFromBoilingPoint(tempC)**
   - Formula: `Math.round(((tempC - 100) / 0.037 + 1013.25) * 10) / 10`
   - Currently at line 308 of egg-calculator.jsx

3. **calculateAltitudeFromPressure(pressureHPa)**
   - Formula: `Math.round(44330 * (1 - Math.pow(pressureHPa / 1013.25, 0.1903)))`
   - Currently at line 312 of egg-calculator.jsx

4. **calculateTime(params)** -- the main cooking time calculation
   - Currently at lines 425-493 of egg-calculator.jsx
   - This is the complex one. In the component it reads from state and calls setState. For extraction, refactor it to be a pure function that:
     - **Accepts** a single params object with these properties:
       ```
       {
         weight,          // egg weight in grams (M)
         startTemp,       // egg start temperature in C (T0)
         targetTemp,      // target yolk temperature in C (Tz)
         boilingPoint,    // water boiling point in C (Tw)
         eggCount,        // number of eggs
         waterVolume,     // water volume in liters
         stovePower,      // stove power in watts
         stoveEfficiency, // stove efficiency (0-1)
         potWeight,       // pot weight in kg
         potHeatCapacity, // pot material heat capacity in kJ/(kg*K)
         waterStartTemp,  // water start temperature in C
         ambientTemp      // ambient temperature in C
       }
       ```
     - **Returns** an object (or null if inputs invalid):
       ```
       {
         cookingTime,     // cooking time in minutes (t_real)
         tempDrop,        // temperature drop in C
         effectiveTemp,   // effective cooking temperature in C
         idealTime,       // ideal cooking time (no temp drop)
         totalEnergy,     // total energy in kJ
         heatingTime      // water heating time in minutes
       }
       ```
     - The validity check is: `weight > 0 && boilingPoint > targetTemp && targetTemp > startTemp` -- return `null` if invalid
     - Copy the exact formulas from the component. Do NOT change any math. The functions must produce byte-for-byte identical results.

   Note: In the component, `getPotHeatCapacity()` looks up pot material. The extracted function receives `potHeatCapacity` directly as a param (the component will do the lookup before calling).

The file should have NO React imports. These are pure JavaScript functions. Add a brief JSDoc comment above each function describing its purpose and formula.
  </action>
  <verify>
Run: `node -e "import('./physics.js').then(m => { console.log(Object.keys(m)); const bp = m.calculateBoilingPointFromPressure(1013.25); console.log('BP at sea level:', bp); console.assert(bp === 100, 'Expected 100'); console.log('OK'); })"` -- should print the four function names and 100 for sea level boiling point.
  </verify>
  <done>physics.js exists with four named exports. calculateBoilingPointFromPressure(1013.25) returns 100. calculatePressureFromBoilingPoint(100) returns 1013.3 (due to rounding). calculateAltitudeFromPressure(1013.25) returns 0. calculateTime with valid params returns a non-null result object with all six properties.</done>
</task>

<task type="auto">
  <name>Task 2: Update EggCalculator to import from physics.js</name>
  <files>egg-calculator.jsx</files>
  <action>
Modify `egg-calculator.jsx` to import and use the extracted physics functions:

1. **Add import** at top of file:
   ```javascript
   import { calculateBoilingPointFromPressure, calculatePressureFromBoilingPoint, calculateAltitudeFromPressure, calculateTime as calculateTimePhysics } from './physics';
   ```
   Note: Import `calculateTime` with an alias (`calculateTimePhysics`) to avoid naming conflict with the internal `calculateTime` function that calls setState.

2. **Remove** the three simple function definitions that are now in physics.js:
   - Remove `const calculateBoilingPointFromPressure = (pressureHPa) => { ... }` (line 304-306)
   - Remove `const calculatePressureFromBoilingPoint = (tempC) => { ... }` (line 308-310)
   - Remove `const calculateAltitudeFromPressure = (pressureHPa) => { ... }` (line 312-314)

   These are now imported. The component already references them by the same names, so all call sites (`handleManualPressure`, `handleManualBoilingPoint`, `getLocationAndPressure`) work without changes.

3. **Refactor the internal `calculateTime` function** (lines 425-493) to call `calculateTimePhysics` and then set state from the result:
   ```javascript
   const calculateTime = () => {
     const potHeatCap = getPotHeatCapacity();
     const result = calculateTimePhysics({
       weight, startTemp, targetTemp, boilingPoint, eggCount, waterVolume,
       stovePower, stoveEfficiency, potWeight, potHeatCapacity: potHeatCap,
       waterStartTemp, ambientTemp
     });

     if (result) {
       setCookingTime(result.cookingTime);
       setTempDrop(result.tempDrop);
       setEffectiveTemp(result.effectiveTemp);
       setIdealTime(result.idealTime);
       setTotalEnergy(result.totalEnergy);
       setHeatingTime(result.heatingTime);
     } else {
       setCookingTime(null);
       setTempDrop(null);
       setEffectiveTemp(null);
       setIdealTime(null);
       setTotalEnergy(null);
       setHeatingTime(null);
     }
   };
   ```

4. **Keep `getPotHeatCapacity` in the component** -- it references `potMaterials` and `potMaterial` state. It stays because it's a UI helper that maps state to a value.

5. **Do NOT change** any other code. No UI changes. No formula changes. Just rewiring.

CRITICAL: After these changes, the app must behave identically. The formulas in physics.js are copied verbatim. The component just delegates to them now.
  </action>
  <verify>
Run: `npm test` -- the existing smoke test must still pass (component renders without crashing).
Run: `npm run build` -- production build must succeed with no errors.
  </verify>
  <done>EggCalculator imports all four physics functions from physics.js. No physics formulas remain defined inside the component closure. Existing smoke test passes. Production build succeeds. The three simple formulas are imported directly, and calculateTime is called via the wrapper that maps result to setState calls.</done>
</task>

</tasks>

<verification>
1. `npm test` passes (existing smoke test)
2. `npm run build` succeeds
3. `node -e "import('./physics.js').then(m => console.log(Object.keys(m)))"` shows all four exports
4. `grep -c "calculateBoilingPointFromPressure" egg-calculator.jsx` shows the function is used but NOT defined (import line + call sites, no arrow function definition)
5. `grep "export" physics.js` shows four named exports
</verification>

<success_criteria>
- physics.js exists with four named exports: calculateBoilingPointFromPressure, calculatePressureFromBoilingPoint, calculateAltitudeFromPressure, calculateTime
- egg-calculator.jsx imports from physics.js and no longer defines physics functions internally
- Existing smoke test passes unchanged
- Production build succeeds
- App behavior is identical (same formulas, same rounding)
</success_criteria>

<output>
After completion, create `.planning/phases/02-physics-validation/02-01-SUMMARY.md`
</output>

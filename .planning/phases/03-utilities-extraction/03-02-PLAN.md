---
phase: 03-utilities-extraction
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - formatters.js
  - egg-calculator.jsx
  - test/formatters.test.js
autonomous: true

must_haves:
  truths:
    - "Formatter functions importable from formatters.js with no React dependency"
    - "Component renders identically after extraction (smoke test passes)"
    - "Component uses imported constants instead of inline arrays"
    - "Component uses imported formatters instead of inline functions"
    - "All formatter outputs match original inline function outputs exactly"
  artifacts:
    - path: "formatters.js"
      provides: "7 formatting functions for time, temperature, volume, weight, pressure"
      exports: ["formatTime", "formatTimerDisplay", "formatCountdown", "formatTemp", "formatVolume", "formatWeight", "formatPressure"]
    - path: "egg-calculator.jsx"
      provides: "Main component importing from constants.js, converters.js, formatters.js, physics.js"
      contains: "import.*from.*constants"
    - path: "test/formatters.test.js"
      provides: "Tests for all 7 formatter functions including edge cases"
  key_links:
    - from: "formatters.js"
      to: "converters.js"
      via: "import { celsiusToFahrenheit, litersToOunces, gramsToOunces, hPaToInHg }"
      pattern: "import.*from.*converters"
    - from: "egg-calculator.jsx"
      to: "constants.js"
      via: "import { STOVE_TYPES, POT_MATERIALS, CONSISTENCY_OPTIONS, EGG_SIZES, START_TEMP_OPTIONS }"
      pattern: "import.*STOVE_TYPES.*from.*constants"
    - from: "egg-calculator.jsx"
      to: "formatters.js"
      via: "import { formatTime, formatTemp, ... }"
      pattern: "import.*formatTime.*from.*formatters"
---

<objective>
Extract formatters into formatters.js and rewire egg-calculator.jsx to import from all extracted modules.

Purpose: Complete the utilities extraction by creating the formatters module (which depends on converters.js from Plan 01) and updating the main component to import constants, converters, and formatters instead of defining them inline. This finishes Phase 3.
Output: formatters.js module, updated egg-calculator.jsx, formatter tests. Component renders identically.
</objective>

<execution_context>
@/Users/beff/.claude/get-shit-done/workflows/execute-plan.md
@/Users/beff/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-utilities-extraction/03-RESEARCH.md
@.planning/phases/03-utilities-extraction/03-01-SUMMARY.md
@egg-calculator.jsx
@physics.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatters.js and update egg-calculator.jsx</name>
  <files>formatters.js, egg-calculator.jsx</files>
  <action>
  Create `formatters.js` in the project root. Extract the 7 formatting functions from egg-calculator.jsx. The formatters that do unit conversion (formatTemp, formatVolume, formatWeight, formatPressure) must import conversion functions from converters.js instead of embedding the math inline.

  IMPORTANT: The 4 format functions that do unit conversion currently reference component state variables (tempUnit, volumeUnit, weightUnit, pressureUnit). In the extracted module, these must become PARAMETERS. Each format function gets a second `unit` parameter.

  The 7 exports:

  1. `formatTime(minutes)` (line 541-546): Returns MM:SS from minutes. Null returns '--:--'.
  2. `formatTimerDisplay(seconds)` (line 548-553): Returns MM:SS from seconds. Null returns '--:--'.
  3. `formatCountdown(seconds)` (line 555-560): Returns MM:SS with zero-padded minutes. Null or negative returns '00:00'.
  4. `formatTemp(tempC, unit)` (line 563-569): If unit==='F', convert via celsiusToFahrenheit and append '°F'. Otherwise append '°C'. Import celsiusToFahrenheit from './converters.js'.
  5. `formatVolume(volumeL, unit)` (line 571-577): If unit==='oz', convert via litersToOunces and append ' oz'. Otherwise append 'L'. Import litersToOunces from './converters.js'.
  6. `formatWeight(weightG, unit)` (line 579-585): If unit==='oz', convert via gramsToOunces and append 'oz'. Otherwise append 'g'. Import gramsToOunces from './converters.js'.
  7. `formatPressure(pressureHPa, unit)` (line 587-593): If unit==='inHg', convert via hPaToInHg and append ' inHg'. Otherwise append ' hPa'. Import hPaToInHg from './converters.js'.

  formatters.js imports ONLY from './converters.js'. No React imports.

  Then update `egg-calculator.jsx`:

  A. Add imports at top:
     - `import { STOVE_TYPES, POT_MATERIALS, CONSISTENCY_OPTIONS, EGG_SIZES, START_TEMP_OPTIONS } from './constants';`
     - `import { formatTime, formatTimerDisplay, formatCountdown, formatTemp, formatVolume, formatWeight, formatPressure } from './formatters';`

  B. Remove inline definitions:
     - Delete the 5 constant arrays (lines 272-306: stoveTypes, potMaterials, consistencyOptions, eggSizes, startTempOptions)
     - Delete the 7 format functions (lines 541-593: formatTime, formatTimerDisplay, formatCountdown, formatTemp, formatVolume, formatWeight, formatPressure)

  C. Update all references to use new names:
     - `stoveTypes` -> `STOVE_TYPES` (used in settings panel, energy section, settings toggle)
     - `potMaterials` -> `POT_MATERIALS` (used in pot material dropdown, getPotHeatCapacity)
     - `consistencyOptions` -> `CONSISTENCY_OPTIONS` (used in consistency selection, egg visualization)
     - `eggSizes` -> `EGG_SIZES` (used in egg size buttons)
     - `startTempOptions` -> `START_TEMP_OPTIONS` (used in start temp buttons)

  D. Update format function calls to pass unit state:
     - `formatTemp(x)` -> `formatTemp(x, tempUnit)` everywhere in JSX
     - `formatVolume(x)` -> `formatVolume(x, volumeUnit)` everywhere in JSX
     - `formatWeight(x)` -> `formatWeight(x, weightUnit)` everywhere in JSX
     - `formatPressure(x)` -> `formatPressure(x, pressureUnit)` everywhere in JSX
     - `formatTime(x)` stays as-is (no unit parameter needed)
     - `formatTimerDisplay(x)` stays as-is
     - `formatCountdown(x)` stays as-is

  E. ALSO update the one inline conversion on line 995 (temp drop display):
     The component has `tempUnit === 'F' ? Math.round(tempDrop * 9 / 5) : tempDrop` — this should import celsiusToFahrenheit from converters.js and use `tempUnit === 'F' ? celsiusToFahrenheit(tempDrop) : tempDrop` (but note: celsiusToFahrenheit adds 32 which is wrong for a delta; this existing code just does `Math.round(tempDrop * 9 / 5)` without +32 since it's a difference, so leave this specific inline math as-is — it's correct for temperature DIFFERENCES, not absolute temps).

  CRITICAL: Do NOT modify any calculation logic, visual output, or component behavior. This is a pure extraction refactoring. Copy exact implementations. The only API change is adding `unit` parameters to the 4 unit-conversion formatters.
  </action>
  <verify>
  Run `npx vitest run` — ALL tests pass (smoke test + physics tests + new constants/converters tests from Plan 01).
  Run `npm run build` — production build succeeds with no errors.
  </verify>
  <done>formatters.js exports 7 functions importing from converters.js. egg-calculator.jsx imports from constants.js, converters.js (if needed), formatters.js, and physics.js. All inline constant arrays and format functions removed. All references updated. Smoke test passes. Build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Write formatter tests</name>
  <files>test/formatters.test.js</files>
  <action>
  Create `test/formatters.test.js` following the patterns from test/physics.test.js and test/converters.test.js.

  Test all 7 exported functions:

  **formatTime(minutes):**
  - Normal: 5.5 -> '5:30', 0 -> '0:00', 10.25 -> '10:15'
  - Null: null -> '--:--'
  - Large: 120.5 -> '120:30'

  **formatTimerDisplay(seconds):**
  - Normal: 90 -> '1:30', 0 -> '0:00', 300 -> '5:00'
  - Null: null -> '--:--'

  **formatCountdown(seconds):**
  - Normal: 90 -> '01:30', 0 -> '00:00', 600 -> '10:00'
  - Null: null -> '00:00'
  - Negative: -5 -> '00:00'

  **formatTemp(tempC, unit):**
  - Celsius: formatTemp(100, 'C') -> '100°C', formatTemp(0, 'C') -> '0°C'
  - Fahrenheit: formatTemp(100, 'F') -> '212°F', formatTemp(0, 'F') -> '32°F'
  - Default unit (no second arg): formatTemp(20) -> '20°C' (default should be 'C')

  **formatVolume(volumeL, unit):**
  - Liters: formatVolume(1.5, 'L') -> '1.5L'
  - Ounces: formatVolume(1.0, 'oz') -> '33.8 oz'
  - Default: formatVolume(2, 'L') -> '2L'

  **formatWeight(weightG, unit):**
  - Grams: formatWeight(60, 'g') -> '60g'
  - Ounces: formatWeight(60, 'oz') -> '2.1oz'
  - Default: formatWeight(53, 'g') -> '53g'

  **formatPressure(pressureHPa, unit):**
  - hPa: formatPressure(1013.25, 'hPa') -> '1013.25 hPa'
  - inHg: formatPressure(1013.25, 'inHg') -> '29.92 inHg'

  Use `it.each()` table-driven format where there are 3+ test cases. Use individual `it()` blocks for edge cases.

  Set default parameter for unit in formatters.js: formatTemp(tempC, unit = 'C'), formatVolume(volumeL, unit = 'L'), formatWeight(weightG, unit = 'g'), formatPressure(pressureHPa, unit = 'hPa').
  </action>
  <verify>Run `npx vitest run test/formatters.test.js` — all tests pass.</verify>
  <done>test/formatters.test.js validates all 7 formatter functions with normal values, edge cases, and both unit options. All tests pass.</done>
</task>

</tasks>

<verification>
1. `npx vitest run` — ALL tests pass (physics, constants, converters, formatters, smoke test)
2. `npm run build` — production build succeeds
3. Verify no inline constant arrays remain in egg-calculator.jsx: grep for `const stoveTypes =`, `const potMaterials =`, etc. — zero matches
4. Verify no inline format functions remain: grep for `const formatTime =`, `const formatTemp =`, etc. inside egg-calculator.jsx — zero matches
5. Verify imports exist: grep for `import.*from.*constants` and `import.*from.*formatters` in egg-calculator.jsx — both present
6. Verify dependency flow is one-way: formatters.js imports from converters.js only. No circular deps.
</verification>

<success_criteria>
- formatters.js exports 7 pure functions, imports only from converters.js
- egg-calculator.jsx imports from 4 modules: physics, constants, formatters (+ useTranslation)
- All 5 inline constant arrays removed from component
- All 7 inline format functions removed from component
- All format calls updated to pass unit parameter
- ALL tests pass (physics + constants + converters + formatters + smoke)
- Production build succeeds
- Phase 3 success criteria met:
  1. Physics calculations importable from physics.js (already done)
  2. Formatter/converter functions importable from formatters.js and converters.js
  3. Constants extracted into constants.js
  4. All extracted functions pass tests
  5. Main component still renders (smoke test passes)
</success_criteria>

<output>
After completion, create `.planning/phases/03-utilities-extraction/03-02-SUMMARY.md`
</output>
